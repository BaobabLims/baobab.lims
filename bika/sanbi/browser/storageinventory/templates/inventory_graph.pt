<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
            metal:use-macro="here/main_template/macros/master"
      i18n:domain="bika">

<head>
    <metal:javascript_head_slot fill-slot="javascript_head_slot">
        <script type="text/javascript" charset="utf-8">
            // Get positions informations
            var path = window.location.href.split('/graphic')[0] + '/inventory_positions_info';
            $.getJSON(path, function(data){
                if(data.positions.length > 0){
                    createGraphic(data);
                }
            });

            function tableStats(data){
                var totalPositions = data.positions.length;
                var freePositions = 0, occupiedPositions = 0;
                for (var i=0; i< totalPositions; i++){
                    if(data.positions[i]["occupied"])
                        occupiedPositions ++;
                    else
                        freePositions ++;
                }
                var html = "<table class='box-info'>" +
                           "<tbody>" +
                           "<tr><td> Total Positions </td>" +
                           "<td>" + data['positions'].length + "</td><tr>" +
                           "<tr><td> Available Positions </td>" +
                           "<td>" + freePositions + "</td><tr>" +
                           "<tr><td> Occupied Positions</td>"   +
                           "<td>" + occupiedPositions + "</td></tr>" +
                           "</tbody></table>";
                $("#stats").append(html);
            }

            function renderSampleTable(data) {
                $("div#pos-info-div").removeClass("hidden");
                var html = "<table class='pos-info'>" +
                    "<tbody>" +
                    "<tr><td> Stock Item ID </td>" +
                    "<td><a href='" + data['path'] +"'> " + data["id"] + "</a></td><tr>" +
                    "<tr><td> Product Title </td>" +
                    "<td>" + data['product'] + "</td><tr>" +
                    "<tr><td> Quantity </td>" +
                    "<td>" + data['quantity'] + " ml</td><tr>" +
                    "</tbody></table>";

                $("div#pos-info-div table").remove();
                $("div#pos-info-div").append(html);
            }

            function positionInfo(element, d) {
                var sample = null;
                if (d['occupied']) {
                    var path = window.location.href.split('/graphic')[0] + '/inventory_item_info';
                    $.ajax({
                        dataType: "json",
                        url: path,
                        data: {'position': d['id']},
                        success: function (data) {
                            console.log('here');
                            renderSampleTable(data);
                        }
                    });
                }else{
                    $("div#pos-info-div").addClass("hidden");
                }
            }
            function createGraphic(data){
                tableStats(data);
                var width = 700;
                var height = 500;
                var padding = 3;
                var marginTop = 30;
                var marginLeft = 30;
                var marginRight = 200;
                var widthPos = width - marginRight - marginLeft;
                var heightPos = height - marginTop;
                var rowCol = data["x"] + data["y"];
                var letters = ["A", "B", "C", "D", "E", "F", "G", "H",
                             "I", "J", "K", "L", "M", "N", "O", "P",
                             "Q", "R", "S", "T", "U", "V", "W", "X",
                             "Y", "Z"];
                // Create SVG element
                var wrapper = d3.select("body")
                                .append("div")
                                .attr("class", "wrapper");

                var graph = d3.select("#content-core")
                              .append("div")
                              .attr("id", "graphic")
                              .attr("class", "graphic");

                var svg = d3.select("#graphic")
                            .append("svg")
                            .attr("width", width)
                            .attr("height", height);

                var totalg = parseInt(rowCol + data["positions"].length);

                var gp = svg.selectAll("g")
                            .data(d3.range(totalg))
                            .enter()
                            .append("g")
                            .attr("i", function(d, i){
                                return i;
                            })
                            .attr("class", function (d) {
                                if (d < data["x"])
                                    return "x-labels";
                                else if (d >= data["x"] && d < parseInt(rowCol)) {
                                    return "y-labels";
                                }else return "graph-svg";
                            })
                            .on("click", function () {
                                gp.classed("on", false);
                                d3.select(this).classed("on", true);
                            });

                var xLabels = svg.selectAll("g.x-labels");
                var yLabels = svg.selectAll("g.y-labels");
                var graphSVG = svg.selectAll("g.graph-svg")
                                  .data(data["positions"]);

                xLabels.selectAll("text")
                       .data(function () {
                           return [d3.select(this.parentNode).datum()];
                       })
                       .enter()
                       .append("text")
                       .text(function(d){
                           return d;
                       })
                       .attr("x", function(d){
                           var i = d3.select(this.parentNode).attr("i");
                           var x = i % data["x"] * Math.floor(widthPos / data["x"]) + marginLeft;
                           var w = widthPos / data["x"] - padding;
                           return x + w / 2;
                       })
                       .attr("y", function(d, i){
                           return marginTop - 10;
                       });

                yLabels.selectAll("text")
                       .data(function () {
                           return [d3.select(this.parentNode).datum()];
                       })
                       .enter()
                       .append("text")
                       .text(function(d){
                           return letters[d - data["y"]];
                       })
                       .attr("x", function(d, i){
                           return marginLeft - 20;
                       })
                       .attr("y", function(d){
                           var i = d3.select(this.parentNode).attr("i");
                           var y = (i - data["y"]) % data["y"] * Math.floor(heightPos / data["y"]) + marginTop;
                           var w = heightPos / data["y"] - padding;
                           return y + w / 2;
                       });

                graphSVG.selectAll("rect")
                        .data(function () {
                            return [d3.select(this.parentNode).datum()];
                        })
                        .enter()
                        .append("rect")
                        .attr("x", function(d){
                            var i = d3.select(this.parentNode).attr("i");
                            return (i - rowCol) % data["x"] * Math.floor(widthPos / data["x"]) + marginLeft;
                        })
                        .attr("y", function(d){
                            var i = d3.select(this.parentNode).attr("i");
                            return Math.floor((i - rowCol) / data["y"]) * heightPos / data["y"] + marginTop;
                        })
                        .attr("width", function(d) {
                            return widthPos / data["y"] - padding;
                        })
                        .attr("height", function(d){
                            return heightPos / data["x"] - padding;
                        })
                        .attr("fill", function(d){
                            return "#dadada";
                        })
                        .style("stroke", "#eee")
                        .style("fill-opacity", .7);

                graphSVG.selectAll("circle")
                        .data(function () {
                            return [d3.select(this.parentNode).datum()];
                        })
                        .enter()
                        .append("circle")
                        .attr("cx", function(d){
                            var i = d3.select(this.parentNode).attr("i");
                            var x = (i - rowCol) % data["x"] * Math.floor(widthPos / data["x"]) + marginLeft;
                            var w = widthPos / data["x"] - padding;
                            return x + w / 2;
                        })
                        .attr("cy", function(d){
                            var i = d3.select(this.parentNode).attr("i");
                            var y = Math.floor((i - rowCol) / data["y"]) * heightPos / data["x"] + marginTop;
                            var h = heightPos / data["y"] - padding;
                            return y + h / 2;
                        })
                        .attr("r", function(d){
                            var w = widthPos / data["x"] - padding;
                            var h = heightPos / data["y"] - padding;
                            return d3.max([w / 2 - 2*padding, h / 2 - 2*padding])
                        })
                        .attr("fill", function(d){
                            if(d['occupied']) return "#fc7871";
                            else return "#32ce16";
                        })
                        .style("fill-opacity", .5)
                        .on("click", function(d){
                            positionInfo(this, d);
                        });

                var positionState = [["Free", "#32ce16"],
                                     ["Occupied", "#fc7871"]];

                var legend = svg.append("g")
                                .attr("class", "legend")
                                .attr("x", width - 150)
                                .attr("y", 25 + marginTop)
                                .attr("height", 100)
                                .attr("width", 100);

                legend.selectAll('circle')
                      .data(positionState)
                      .enter()
                      .append("circle")
                      .attr("cx", width - 150)
                      .attr("cy", function(d, i){
                          return i*25 + marginTop + 5;
                      })
                      .attr("r", 6)
                      .style("fill", function(d,i){
                          return d[1];
                      });

                legend.selectAll("text")
                      .data(positionState)
                      .enter()
                      .append("text")
                      .attr("x", width - 128)
                      .attr("y", function(d, i){
                          return i * 25 + marginTop + 8;
                      })
                      .attr("height",30)
                      .attr("width",100)
                      .text(function(d, i){
                          return d[0];
                      })
                      .style("font-family", "sans-serif")
                      .style("font-weight", "bold");
            }
        </script>
    </metal:javascript_head_slot>
    <metal:block fill-slot="style_slot">
        <tal:css>
        <style type="text/css">
            rect:hover{
                fill: orange;
            }
            rect {
                -moz-transition: all 0.3s;
                -o-transition: all 0.3s;
                -webkit-transition: all 0.3s;
                transition: all 0.3s;
            }
            circle:hover{
                fill: black;
            }
            g.on > rect{
                fill:orange;
            }
            .legend {
	            padding: 5px;
	            font: 10px sans-serif;
	            background: yellow;
	            box-shadow: 2px 2px 1px #888;
            }
            #content-core > div:first-of-type{
                float: left;
                clear: none;
                margin: 20px 0;
                width: 30%;
            }
            div.table-info{
            }
            span.head-text{
                font-family: sans-serif;
                font-size: 14px;
                font-weight: bold;
            }
            div.table-info table {
                border: solid 1px #DDEEEE;
                border-collapse: collapse;
                border-spacing: 0;
                font: normal 13px Arial, sans-serif;
                width:100%;
            }
            div.table-info table tbody td {
                border: solid 1px #DDEEEE;
                color: #333;
                padding: 10px;
                text-shadow: 1px 1px 1px #fff;
            }

            div#graphic{
                margin: 20px 30px;
                float: left;
                width: 50%;
            }
            .hidden{
                display: none;
            }
            rect:hover {
				fill: orange;
			}

            g.x-labels, g.y-labels{
                fill: gray;
            }
            table.box-info{
                margin-top: 7px;
            }
            table.pos-info{
                margin-top: 7px;
            }
        </style>
        </tal:css>
    </metal:block>
</head>
<body>

<metal:title fill-slot="content-title">
</metal:title>

<metal:content-description fill-slot="content-description">
</metal:content-description>

<div metal:fill-slot="content-core"
     tal:define="
        portal context/@@plone_portal_state/portal;">
    <div class="table-info">
        <div id="stats">
            <img tal:attributes='src python:portal.absolute_url()+"/++resource++bika.sanbi.images/graph.png"'/>
            <span class="head-text">Statistics</span>
        </div>
        <p ></p>
        <div id="pos-info-div" class="hidden" style="border-top: 1px solid deepskyblue; padding-top: 5px;">
            <img tal:attributes='src python:portal.absolute_url()+"/++resource++bika.sanbi.images/item.png"'/>
            <span class="head-text">Stock Item</span>
        </div>
    </div>
</div>
</body>
</html>